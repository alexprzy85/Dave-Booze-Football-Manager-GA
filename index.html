<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dave Booze: Hanham Abbotonians Football Manager</title>
    <!-- Google tag (gtag.js) --> 
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JCKGYXWEY1"></script> 
    <script> 
      window.dataLayer = window.dataLayer || []; 
      function gtag(){dataLayer.push(arguments);} 
      gtag('js', new Date()); 

      gtag('config', 'G-JCKGYXWEY1'); 
    </script>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons (e.g., football, whistle, trophy) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0A1128; /* Dark Navy Blue */
            color: #FDD835; /* Yellow */
        }
        .container {
            max-width: 960px;
        }
        .btn {
            background-color: #FDD835; /* Yellow */
            color: #0A1128; /* Dark Navy Blue */
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 2px solid #FDD835;
        }
        .btn:hover {
            background-color: #0A1128; /* Dark Navy Blue */
            color: #FDD835; /* Yellow */
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.2);
            border: 2px solid #FDD835;
        }
        .btn:disabled {
            background-color: #555;
            color: #ccc;
            cursor: not-allowed;
            border: 2px solid #555;
            box-shadow: none;
        }
        .card {
            background-color: #1C274E; /* Slightly lighter navy */
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
        }
        .message-box, .substitution-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #1C274E;
            color: #FDD835;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: none; /* Hidden by default */
            max-width: 90%;
            text-align: center;
        }
        .message-box button, .substitution-modal button {
            margin-top: 1rem;
            cursor: pointer;
        }
        input[type="text"], input[type="number"], select {
            background-color: #0A1128;
            border: 1px solid #FDD835;
            color: #FDD835;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            width: 100%;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid rgba(253, 216, 53, 0.2); /* Light yellow border */
        }
        th {
            background-color: rgba(253, 216, 53, 0.1); /* Very light yellow tint */
        }
        .scrollable-list {
            max-height: 300px; /* Adjust as needed */
            overflow-y: auto;
            border: 1px solid rgba(253, 216, 53, 0.2);
            border-radius: 0.5rem;
            padding: 0.5rem;
        }
        .commentary-log {
            background-color: #0A1128;
            border: 1px solid #FDD835;
            border-radius: 0.5rem;
            padding: 1rem;
            max-height: 400px;
            overflow-y: auto;
            text-align: left;
            font-size: 0.9rem;
        }
        .commentary-log p {
            margin-bottom: 0.5rem;
        }
        /* Style for player list to minimize scrolling */
        .player-role-selection .scrollable-list {
            max-height: 450px; /* Adjusted to fit more players */
        }
        .player-role-selection .player-item span {
            font-size: 0.85rem; /* Smaller font for player details */
        }
        .player-role-selection .player-item span.text-xs {
            font-size: 0.75rem; /* Even smaller for stats */
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div id="game-container" class="container mx-auto p-6 bg-0A1128 rounded-lg shadow-xl text-center">
        <!-- Game content will be loaded here by JavaScript -->
        <h1 class="text-4xl font-extrabold mb-8 text-FDD835 uppercase tracking-wide">
            Dave Booze: Hanham Abbotonians Football Manager
        </h1>
        <div id="game-screen" class="card">
            <!-- Content will be injected here -->
        </div>
    </div>

    <!-- Message Box for Alerts -->
    <div id="message-box" class="message-box">
        <p id="message-text"></p>
        <button onclick="hideMessageBox()" class="btn">OK</button>
    </div>

    <!-- Substitution Modal -->
    <div id="substitution-modal" class="substitution-modal">
        <h3 class="text-2xl font-bold mb-4">Make a Substitution</h3>
        <p class="mb-4">Select a player to come off and a player to come on.</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label for="player-off-select" class="block text-sm font-bold mb-1">Player Off:</label>
                <select id="player-off-select" class="w-full">
                    <option value="">-- Select Player Off --</option>
                </select>
            </div>
            <div>
                <label for="player-on-select" class="block text-sm font-bold mb-1">Player On:</label>
                <select id="player-on-select" class="w-full">
                    <option value="">-- Select Player On --</option>
                </select>
            </div>
        </div>
        <div class="flex justify-center gap-4">
            <button onclick="performSubstitution()" class="btn">Confirm Sub</button>
            <button onclick="cancelSubstitution()" class="btn">Cancel</button>
        </div>
    </div>

    <!-- Audio Elements -->
    <audio id="goal-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-small-group-cheer-and-applause-2015.mp3" preload="auto"></audio>
    <audio id="whistle-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-sport-whistle-3184.mp3" preload="auto"></audio>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase Initialization
        let app;
        let db;
        let auth;
        let userId = 'anonymous'; // Default to anonymous
        let isAuthReady = false;

        // Game State Variables
        let currentWeek = 0;
        let totalWeeks; // Will be determined by fixture generation
        let natchCider = 0;
        let userName = '';
        let seasonComplete = false;
        let selectedSquad = []; // Players selected for match-day squad (starters + subs, up to 15)
        let selectedLineup = []; // Players currently on the field (exactly 11)
        let designatedGoalkeeperId = null;
        let matchInterval; // For live match commentary
        let matchMinutes = 0;
        let isMatchPaused = false;
        let hanhamGoals = []; // To store goal scorers

        const teams = [
            { name: "Hanham Abbotonians", strength: 70 },
            { name: "Longwell Green", strength: 75 },
            { name: "Keynsham Town", strength: 68 },
            { name: "Oldland Abbotonians", strength: 72 },
            { name: "Mangotsfield Utd", strength: 78 },
            { name: "Warmley Rangers", strength: 65 },
            { name: "Pucklechurch Sports", strength: 63 },
            { name: "Cadbury Heath", strength: 70 },
            { name: "Emersons Green", strength: 73 },
            { name: "Bradley Stoke", strength: 69 },
            { name: "Yate Town", strength: 76 }
        ];

        // Updated Player Data with detailed personalities and initial stats
        let players = [
            { id: 'p1', name: "Ashton", personality: "mischievous", position: "Defender", fitness: 80, morale: 70, readiness: 0, isInjured: false, injuryDuration: 0, matchRating: 0, attendanceBias: -10, parentId: 'pr1', description: "Small left defender, often talks during team talks, regularly falls out with Caspar." },
            { id: 'p2', name: "Connor", personality: "injuryProne", position: "Defender", fitness: 75, morale: 80, readiness: 0, isInjured: false, injuryDuration: 0, matchRating: 0, attendanceBias: 0, parentId: 'pr2', description: "Tall right sided defender, can play in attack. Best friend is Ewan." },
            { id: 'p3', name: "Stan", personality: "injuryProne", position: "Midfielder", fitness: 70, morale: 75, readiness: 0, isInjured: false, injuryDuration: 0, matchRating: 0, attendanceBias: 0, parentId: 'pr3', description: "Central defender or midfield. Excellent first touch. Has bad hips and knees." },
            { id: 'p4', name: "Leon", personality: "quiet", position: "Defender", fitness: 85, morale: 80, readiness: 0, isInjured: false, injuryDuration: 0, matchRating: 0, attendanceBias: 5, parentId: 'pr4', description: "Central defender or midfield. Battles well but very quiet. Best friend is Zain." },
            { id: 'p5', name: "Kyle R", personality: "injuryProne", position: "Defender", fitness: 70, morale: 75, readiness: 0, isInjured: false, injuryDuration: 0, matchRating: 0, attendanceBias: -5, parentId: 'pr5', description: "Right defender. Great in a slide tackle and reads the game well but gets injured most of the time." },
            { id: 'p6', name: "Caspar", personality: "moaner", position: "Midfielder", fitness: 78, morale: 65, readiness: 0, isInjured: false, injuryDuration: 0, matchRating: 0, attendanceBias: -15, parentId: 'pr6', description: "Left wing or left back. Uses his hands constantly, moans when things aren't going his way, falls out with the team and his dad. Regularly falls out with Ashton." },
            { id: 'p7', name: "Ewan", personality: "cricketLover", position: "Midfielder", fitness: 80, morale: 75, readiness: 0, isInjured: false, injuryDuration: 0, matchRating: 0, attendanceBias: -30, parentId: 'pr7', description: "Left wing. Long blonde hair. Unreliable in the summer as he prefers to play cricket. Best friend is Connor." },
            { id: 'p8', name: "Zain", personality: "unreliable", position: "Forward", fitness: 90, morale: 85, readiness: 0, isInjured: false, injuryDuration: 0, matchRating: 0, attendanceBias: -20, parentId: 'pr8', description: "Attack, right or left wing. Very fast and good finisher. When available, he is great. Unreliable due to parent's takeaway." },
            { id: 'p9', name: "Billy", personality: "lowConfidence", position: "Forward", fitness: 80, morale: 60, readiness: 0, isInjured: false, injuryDuration: 0, matchRating: 0, attendanceBias: -5, parentId: null, description: "Right wing or attack. Short of confidence but good player. Often asks to come off with a bad knee or groin. Best friends with Ashton." },
            { id: 'p10', name: "Isaac", personality: "quiet", position: "Forward", fitness: 85, morale: 70, readiness: 0, isInjured: false, injuryDuration: 0, matchRating: 0, attendanceBias: 0, parentId: null, description: "Wing or attack. Very fast and has become more physical. Doesn't interact verbally too much with the team." },
            { id: 'p11', name: "Jakub", personality: "creative", position: "Midfielder", fitness: 88, morale: 90, readiness: 0, isInjured: false, injuryDuration: 0, matchRating: 0, attendanceBias: 10, parentId: 'pr9', description: "Central midfield, attack. Very intelligent, creative footballer. Top scorer last season. Good at slide tackles and heading." },
            { id: 'p12', name: "Charlie", personality: "speedy", position: "Defender", fitness: 82, morale: 80, readiness: 0, isInjured: false, injuryDuration: 0, matchRating: 0, attendanceBias: 5, parentId: 'pr10', description: "Central defender. Loves long mazy runs. Great speed and recovery tackle." },
            { id: 'p13', name: "Harry", personality: "fittest", position: "Midfielder", fitness: 95, morale: 88, readiness: 0, isInjured: false, injuryDuration: 0, matchRating: 0, attendanceBias: 15, parentId: 'pr11', description: "Very good footballer. Fittest player in the team, runs all day. Links up well with Jakub. Rumours he wants to join rivals Boco." },
            { id: 'p14', name: "Archie", personality: "aggressive", position: "Defender", fitness: 75, morale: 70, readiness: 0, isInjured: false, injuryDuration: 0, matchRating: 0, attendanceBias: 0, parentId: 'pr12', description: "Central defender. Likes a tackle. Gets angry at himself. Good long kick." },
            // Fictional players to ensure squad depth (total 15 players minimum initially)
            { id: 'p15', name: "Sam P", personality: "consistent", position: "Midfielder", fitness: 85, morale: 85, readiness: 0, isInjured: false, injuryDuration: 0, matchRating: 0, attendanceBias: 5, parentId: null, description: "Reliable midfielder, always gives his best." },
            { id: 'p16', name: "Tom W", personality: "enthusiastic", position: "Forward", fitness: 78, morale: 90, readiness: 0, isInjured: false, injuryDuration: 0, matchRating: 0, attendanceBias: 10, parentId: null, description: "Energetic forward, loves scoring goals." },
            { id: 'p17', name: "Finley B", personality: "quiet", position: "Defender", fitness: 80, morale: 75, readiness: 0, isInjured: false, injuryDuration: 0, matchRating: 0, attendanceBias: 0, parentId: null, description: "Solid defender, calm and composed." },
            { id: 'p18', name: "Max C", personality: "leader", position: "Midfielder", fitness: 88, morale: 88, readiness: 0, isInjured: false, injuryDuration: 0, matchRating: 0, attendanceBias: 10, parentId: null, description: "Natural leader, inspires the team." },
            { id: 'p19', name: "Leo H", personality: "speedy", position: "Forward", fitness: 83, morale: 80, readiness: 0, isInjured: false, injuryDuration: 0, matchRating: 0, attendanceBias: 5, parentId: null, description: "Quick winger, loves to take on defenders." }
        ];

        // Updated Parent Data with detailed descriptions
        const parents = [
            { id: 'pr1', name: "Aimee", childName: "Ashton", reactionBias: -5, happiness: 70, description: "Club safeguarding officer. You often see her dealing with Ashton's mischief." },
            { id: 'pr2', name: "Gail", childName: "Connor", reactionBias: 0, happiness: 80, description: "Runs the club's bar with Emma. She's used to Connor asking to come off injured." },
            { id: 'pr3', name: "Emma", childName: "Stan", reactionBias: 5, happiness: 85, description: "Works on the bar with Gail. She's Stan's parent (Dave's own son)." },
            { id: 'pr4', name: "Mrs. Leon", childName: "Leon", reactionBias: 0, happiness: 75, description: "Leon's parent. She's very supportive but doesn't interact much." },
            { id: 'pr5', name: "Marcus", childName: "Kyle R", reactionBias: 10, happiness: 90, description: "A true club man, runs the line sometimes, and plays for the adult team (who get thrashed every week). Always positive." },
            { id: 'pr6', name: "Craig", childName: "Caspar", reactionBias: -10, happiness: 60, description: "Dave's assistant manager. Often distracted, loves 'duck, duck, goose' during training. His strained relationship with Caspar is noticeable." },
            { id: 'pr7', name: "Neil", childName: "Ewan", reactionBias: -15, happiness: 65, description: "Never helps set up the pitch or run the line; just sits drinking coffee. Dave wonders why he even comes." },
            { id: 'pr8', name: "Raul", childName: "Zain", reactionBias: -20, happiness: 55, description: "Owns local takeaway 'Curry Nights', which often affects Zain's attendance. You can tell he prioritizes the business." },
            { id: 'pr9', name: "Alex", childName: "Jakub", reactionBias: 5, happiness: 85, description: "Loves a beer, helps setup goal posts with Matt. Often shouts at Jakub from the side, causing arguments." },
            { id: 'pr10', name: "Jade", childName: "Charlie", reactionBias: 0, happiness: 78, description: "Posh, drives a 4x4. Always punctual but keeps to herself." },
            { id: 'pr11', name: "Matt", childName: "Harry", reactionBias: 10, happiness: 92, description: "Loves a beer with Alex, helps setup goal posts. Brings dog poo bags. Wears a backpack, looks like Jason Statham. Always very helpful." },
            { id: 'pr12', name: "Dan", childName: "Archie", reactionBias: 0, happiness: 70, description: "Ex-manager of the team. He has strong opinions but usually keeps them to himself." }
        ];

        let leagueTable = teams.map(team => ({
            ...team,
            played: 0,
            wins: 0,
            draws: 0,
            losses: 0,
            goalsFor: 0,
            goalsAgainst: 0,
            goalDifference: 0,
            points: 0
        }));

        let fixtures = []; // Stores all generated fixtures

        // Audio elements
        const goalSound = document.getElementById('goal-sound');
        const whistleSound = document.getElementById('whistle-sound');

        // Google Analytics (GA4) setup - will be dynamically inserted if needed
        // For local development, this needs to be manually set up or ignored.
        // In Canvas, it should be fine.
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-JCKGYXWEY1'); // Placeholder for a GA4 Measurement ID

        // Function to show custom message box
        function showMessageBox(message, onOk = null) {
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            const okButton = messageBox.querySelector('button');

            messageText.innerHTML = message; // Use innerHTML to allow for simple HTML
            messageBox.style.display = 'block';

            okButton.onclick = () => {
                hideMessageBox();
                if (onOk) onOk();
            };
        }

        function hideMessageBox() {
            document.getElementById('message-box').style.display = 'none';
        }

        // Firebase Initialization and Auth Listener
        const firebaseInit = async () => {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("Firebase Auth Ready. User ID:", userId);
                        } else {
                            // If no user is logged in, try signing in anonymously
                            try {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                    userId = auth.currentUser.uid;
                                    console.log("Signed in with custom token. User ID:", userId);
                                } else {
                                    await signInAnonymously(auth);
                                    userId = auth.currentUser.uid;
                                    console.log("Signed in anonymously. User ID:", userId);
                                }
                            } catch (error) {
                                console.error("Firebase Auth Error:", error);
                                showMessageBox("Failed to authenticate with Firebase. Leaderboard features may be limited.", () => {
                                    userId = crypto.randomUUID(); // Fallback to random ID
                                    isAuthReady = true;
                                    displayWelcomeScreen(); // Proceed even if auth fails
                                });
                            }
                        }
                        isAuthReady = true;
                        if (!userName) { // Only display welcome screen if user hasn't entered name yet
                            displayWelcomeScreen();
                        }
                        setupLeaderboardListener(); // Setup listener once auth is ready
                    });
                } else {
                    console.warn("Firebase config not provided. Running without Firestore.");
                    userId = crypto.randomUUID(); // Generate a random ID if no Firebase
                    isAuthReady = true;
                    displayWelcomeScreen();
                }
            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
                showMessageBox("Error initializing Firebase. Leaderboard features will be unavailable.", () => {
                    userId = crypto.randomUUID(); // Generate a random ID if Firebase fails
                    isAuthReady = true;
                    displayWelcomeScreen();
                });
            }
        };

        // Leaderboard Functions
        async function saveScoreToLeaderboard(score) {
            if (!db || !userId || !userName) {
                console.warn("Cannot save score: Firebase, userId, or userName not available.");
                return;
            }
            try {
                const leaderboardCollectionRef = collection(db, `artifacts/${appId}/public/data/leaderboard`);
                await addDoc(leaderboardCollectionRef, {
                    userName: userName,
                    score: score,
                    timestamp: new Date(),
                    userId: userId // Store userId for potential future unique user tracking/filtering
                });
                console.log("Score saved to leaderboard!");
            } catch (e) {
                console.error("Error adding document to leaderboard: ", e);
                showMessageBox("Failed to save score to leaderboard. Check console for details.");
            }
        }

        function setupLeaderboardListener() {
            if (!db) {
                console.warn("Firestore not available for leaderboard listener.");
                return;
            }
            const leaderboardCollectionRef = collection(db, `artifacts/${appId}/public/data/leaderboard`);
            const q = query(leaderboardCollectionRef, orderBy("score", "desc"), limit(10)); // Get top 10

            onSnapshot(q, (snapshot) => {
                const scores = [];
                snapshot.forEach((doc) => {
                    scores.push(doc.data());
                });
                displayLeaderboard(scores);
            }, (error) => {
                console.error("Error listening to leaderboard: ", error);
                showMessageBox("Failed to load leaderboard. Check console for details.");
            });
        }

        function displayLeaderboard(scores) {
            const leaderboardHtml = `
                <h3 class="text-2xl font-bold mb-4">Top Dave Booze Managers!</h3>
                <table class="w-full text-sm mb-4">
                    <thead>
                        <tr>
                            <th class="px-2 py-1">Rank</th>
                            <th class="px-2 py-1">Manager</th>
                            <th class="px-2 py-1 text-right">Natch Cider</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${scores.map((s, index) => `
                            <tr>
                                <td class="px-2 py-1">${index + 1}</td>
                                <td class="px-2 py-1">${s.userName}</td>
                                <td class="px-2 py-1 text-right">${s.score} <i class="fas fa-beer text-yellow-400"></i></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            // This will be displayed on the welcome screen.
            const leaderboardDiv = document.getElementById('leaderboard-display');
            const leaderboardDivFinal = document.getElementById('leaderboard-display-final');
            if (leaderboardDiv) {
                leaderboardDiv.innerHTML = leaderboardHtml;
            }
            if (leaderboardDivFinal) {
                leaderboardDivFinal.innerHTML = leaderboardHtml;
            }
        }


        // --- Game Logic Functions ---

        // Helper to generate a unique ID for players/parents
        function generateUniqueId() {
            return 'id-' + Math.random().toString(36).substr(2, 9);
        }

        // Initialize fixtures (round-robin)
        function generateFixtures() {
            const numOriginalTeams = teams.length;
            let actualTeams = [...teams]; // Copy original teams

            // If odd number of teams, add a dummy 'BYE' team
            const hasBye = numOriginalTeams % 2 !== 0;
            if (hasBye) {
                actualTeams.push({ name: "BYE", strength: 0 }); // Add a dummy team for scheduling
            }
            const totalPlayingTeams = actualTeams.length; // Now it's an even number or original odd

            fixtures = [];

            // Generate fixtures for a single round-robin (half season)
            const numWeeksPerRound = totalPlayingTeams - 1;

            // Prepare teams for the round-robin algorithm
            let rotatedTeams = [...actualTeams]; // Use a mutable copy for rotation

            for (let weekOffset = 0; weekOffset < numWeeksPerRound; weekOffset++) {
                // Pair teams for the current week (using fixed first team and rotating rest)
                for (let i = 0; i < totalPlayingTeams / 2; i++) {
                    const team1 = rotatedTeams[i];
                    const team2 = rotatedTeams[totalPlayingTeams - 1 - i];

                    // Add fixture if neither team is 'BYE'
                    if (team1.name !== "BYE" && team2.name !== "BYE") {
                        // First half of season (home/away as generated)
                        fixtures.push({ week: weekOffset + 1, home: team1.name, away: team2.name, result: null, homeScore: 0, awayScore: 0 });
                    }
                }

                // Rotate teams for the next week (except the first team which stays fixed)
                if (totalPlayingTeams > 2) {
                    const fixedTeam = rotatedTeams[0];
                    const lastTeam = rotatedTeams.pop();
                    rotatedTeams.splice(1, 0, lastTeam); // Insert last team after the fixed one
                    rotatedTeams[0] = fixedTeam; // Ensure the first team remains fixed
                }
            }

            // Duplicate fixtures for the second round (reverse home/away)
            const firstRoundFixtures = [...fixtures]; // Capture state of fixtures after first round
            firstRoundFixtures.forEach(f => {
                // Ensure BYE team is not playing home or away in the second round
                if (f.home !== "BYE" && f.away !== "BYE") {
                    fixtures.push({ week: f.week + numWeeksPerRound, home: f.away, away: f.home, result: null, homeScore: 0, awayScore: 0 });
                }
            });

            // Set totalWeeks based on the generated schedule
            totalWeeks = numWeeksPerRound * 2; // For 11 teams (+BYE) = 11*2 = 22 weeks

            // Sort all fixtures by week for proper progression
            fixtures.sort((a, b) => a.week - b.week);

            // Filter out BYE team matches from the main fixtures list if "BYE" team was added
            if (hasBye) {
                fixtures = fixtures.filter(f => f.home !== "BYE" && f.away !== "BYE");
            }

            console.log("Generated Full Fixtures:", fixtures);
        }

        // Calculate player readiness
        function calculateReadiness(player) {
            return Math.round((player.fitness * 0.6 + player.morale * 0.4) / 100 * 100);
        }

        // Update player stats after training
        function updatePlayerStats(trainingType) {
            players.forEach(player => {
                if (player.isInjured) {
                    player.injuryDuration--;
                    if (player.injuryDuration <= 0) {
                        player.isInjured = false;
                        player.injuryDuration = 0;
                        showMessageBox(`${player.name} has recovered from injury!`);
                    }
                    return; // Injured players don't train
                }

                // Apply effects based on personality and training type
                let fitnessChange = 0;
                let moraleChange = 0;
                let personalityMessage = '';

                switch (trainingType) {
                    case 'intense':
                        fitnessChange = Math.floor(Math.random() * 10) + 5; // +5 to +14
                        moraleChange = Math.floor(Math.random() * 5) - 2;   // -2 to +2
                        if (player.personality === 'injuryProne') {
                            if (Math.random() < 0.15) { // 15% chance of injury
                                player.isInjured = true;
                                player.injuryDuration = Math.floor(Math.random() * 3) + 1; // 1-3 weeks out
                                personalityMessage = `${player.name}, with his injury-prone nature, picked up a knock during intense training! Out for ${player.injuryDuration} week(s).`;
                                showMessageBox(personalityMessage);
                            }
                        } else if (player.personality === 'aggressive' && Math.random() < 0.1) {
                            personalityMessage = `${player.name} was very aggressive in training, pushing hard. Good to see his competitive spirit!`;
                        }
                        break;
                    case 'balanced':
                        fitnessChange = Math.floor(Math.random() * 7) + 3; // +3 to +9
                        moraleChange = Math.floor(Math.random() * 7) + 3;   // +3 to +9
                        if (player.personality === 'consistent') {
                            personalityMessage = `${player.name} had a solid, consistent training session.`;
                        }
                        break;
                    case 'fun':
                        fitnessChange = Math.floor(Math.random() * 5) - 1; // -1 to +3
                        moraleChange = Math.floor(Math.random() * 10) + 5;  // +5 to +14
                        if (player.personality === 'mischievous') {
                            moraleChange += 5; // They love fun!
                            if (Math.random() < 0.3) personalityMessage = `Ashton, true to his mischievous nature, was distracting others but loved the fun session! Morale boosted.`;
                        }
                        if (player.personality === 'moaner') {
                            moraleChange += 8; // Fun boosts these types more
                            if (Math.random() < 0.5) personalityMessage = `Even Caspar seemed to enjoy the fun session, his mood significantly improved!`;
                        }
                        if (player.personality === 'lowConfidence') {
                            moraleChange += 8; // Fun boosts these types more
                            personalityMessage = `${player.name}'s confidence seemed to lift during the fun training!`;
                        }
                        break;
                }

                player.fitness = Math.max(0, Math.min(100, player.fitness + fitnessChange));
                player.morale = Math.max(0, Math.min(100, player.morale + moraleChange));
                player.readiness = calculateReadiness(player);

                if (personalityMessage && !player.isInjured) { // Only show if not already showing injury message
                    showMessageBox(personalityMessage);
                }
            });
        }

        // Simulate Spond attendance
        function simulateSpondAttendance() {
            players.forEach(player => {
                if (player.isInjured) {
                    player.isAttending = false; // Injured players cannot attend
                    return;
                }
                let attendanceChance = 80; // Base 80% chance
                let personalityReason = '';
                switch (player.personality) {
                    case 'mischievous':
                        attendanceChance -= 20;
                        personalityReason = " (Dave suspects he's up to something else)";
                        break;
                    case 'injuryProne':
                        attendanceChance -= 5;
                        personalityReason = " (feeling a niggle)";
                        break;
                    case 'cricketLover':
                        attendanceChance -= 30;
                        personalityReason = " (probably off playing cricket)";
                        break;
                    case 'consistent': attendanceChance += 10; break;
                    case 'enthusiastic': attendanceChance += 5; break;
                    case 'unreliable':
                        attendanceChance -= 25;
                        if (player.parentId) {
                            const parent = parents.find(p => p.id === player.parentId);
                            if (parent && parent.name === 'Raul') {
                                personalityReason = ` (Parent Raul's takeaway, Curry Nights, is keeping him busy)`;
                            }
                        }
                        break;
                    case 'moaner':
                        attendanceChance -= 10;
                        personalityReason = " (might just not feel like it)";
                        break;
                }
                attendanceChance += player.attendanceBias; // From initial player setup

                player.isAttending = Math.random() * 100 < attendanceChance;
                if (!player.isAttending && !player.isInjured) {
                    // console.log(`${player.name} is unavailable via Spond${personalityReason}.`); // For debug
                }
            });
        }

        // Display current game screen
        function renderScreen(contentHtml) {
            document.getElementById('game-screen').innerHTML = contentHtml;
        }

        function displayWelcomeScreen() {
            if (!isAuthReady) {
                // Wait for Firebase auth to be ready before displaying welcome screen
                setTimeout(displayWelcomeScreen, 100);
                return;
            }

            let welcomeHtml = `
                <div class="p-6">
                    <p class="text-xl mb-6">Welcome to the world of Dave Booze, manager of Hanham Abbotonians Youth U14 Eagles!</p>
                    <p class="mb-4">Enter your manager name to start your journey and see your performance on the leaderboard:</p>
                    <input type="text" id="manager-name-input" placeholder="Your Manager Name" class="mb-6 max-w-sm mx-auto">
                    <button id="start-game-btn" class="btn text-xl px-8 py-3 w-full max-w-sm mx-auto flex items-center justify-center">
                        Start Season <i class="fas fa-play ml-2"></i>
                    </button>
                    <div id="leaderboard-display" class="mt-8 card text-left">
                        <!-- Leaderboard will be displayed here -->
                    </div>
                </div>
            `;
            renderScreen(welcomeHtml);

            document.getElementById('manager-name-input').value = userName; // Pre-fill if already set
            document.getElementById('start-game-btn').addEventListener('click', () => {
                const inputName = document.getElementById('manager-name-input').value.trim();
                if (inputName.length < 3) {
                    showMessageBox("Please enter a manager name at least 3 characters long.");
                    return;
                }
                userName = inputName;
                generateFixtures(); // Generate fixtures once at the start of the game
                startWeek();
            });
            // If Firebase is initialized, the leaderboard listener will automatically update this div.
        }


        function startWeek() {
            if (currentWeek >= totalWeeks) {
                endSeason();
                return;
            }

            currentWeek++;
            // Update injuries (players recover each week)
            players.forEach(player => {
                if (player.isInjured && player.injuryDuration > 0) {
                    player.injuryDuration--;
                    if (player.injuryDuration === 0) {
                        player.isInjured = false;
                        showMessageBox(`${player.name} has recovered from injury!`);
                    }
                }
            });

            simulateSpondAttendance();

            // Determine current Hanham fixture for the week
            const hanhamFixtureForThisWeek = fixtures.find(f =>
                f.week === currentWeek && (f.home === "Hanham Abbotonians" || f.away === "Hanham Abbotonians")
            );

            if (!hanhamFixtureForThisWeek) {
                // If Hanham doesn't have a game this week, simulate other games and move to next week
                // This shouldn't happen with the new fixture generation if totalWeeks is correct.
                showMessageBox(`Hanham Abbotonians have a bye week! Simulating other league results.`, () => {
                     simulateOtherLeagueResults(currentWeek, "Hanham Abbotonians");
                     sortLeagueTable();
                    startWeek(); // Immediately go to next week
                });
                return;
            }


            const pitch = (currentWeek >= 1 && currentWeek <= (totalWeeks / 2)) ? "Lees Hill (Grass)" : "Kings Oak School (4G)";
            const availablePlayers = players.filter(p => p.isAttending).length;

            let trainingHtml = `
                <h2 class="text-3xl font-bold mb-4">Week ${currentWeek}: Training & Spond Check</h2>
                <p class="text-lg mb-2">Pitch: ${pitch}</p>
                <p class="text-lg mb-4">Available for training via Spond: <span class="font-bold text-yellow-400">${availablePlayers} players</span></p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 text-left">
                    <div class="card p-4">
                        <h3 class="text-xl font-bold mb-2">Training Attendees:</h3>
                        <ul class="list-disc list-inside scrollable-list">
                            ${players.filter(p => p.isAttending).map(p => `
                                <li class="${p.isInjured ? 'text-red-400 line-through' : ''}">
                                    ${p.name} (${p.position}) <br>
                                    <span class="text-xs text-gray-400">${p.description || ''}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    <div class="card p-4">
                        <h3 class="text-xl font-bold mb-2">Unavailable Players:</h3>
                        <ul class="list-disc list-inside scrollable-list">
                            ${players.filter(p => !p.isAttending).map(p => `
                                <li>
                                    ${p.name} (${p.position}) <br>
                                    <span class="text-xs text-gray-400">
                                        ${p.isInjured ? `Injured: ${p.injuryDuration} week(s)` : 'Unavailable via Spond'}
                                    </span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                </div>

                <h3 class="text-2xl font-bold mb-4">Choose Training Session:</h3>
                <div class="flex flex-col md:flex-row gap-4 justify-center mb-6">
                    <button onclick="conductTraining('intense')" class="btn flex-1">Intense <br><span class="text-sm">(High Fitness, Risk of Injury)</span></button>
                    <button onclick="conductTraining('balanced')" class="btn flex-1">Balanced <br><span class="text-sm">(Good all-round)</span></button>
                    <button onclick="conductTraining('fun')" class="btn flex-1">Fun <br><span class="text-sm">(High Morale, Low Fitness)</span></button>
                </div>

                <div class="mt-8 text-left">
                    <h3 class="text-2xl font-bold mb-4">Add New Player/Parent:</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="new-player-name" class="block text-sm font-bold mb-1">Player Name:</label>
                            <input type="text" id="new-player-name" placeholder="New Player Name" class="mb-2">
                        </div>
                        <div>
                            <label for="new-player-pos" class="block text-sm font-bold mb-1">Position:</label>
                            <select id="new-player-pos" class="mb-2">
                                <option value="Forward">Forward</option>
                                <option value="Midfielder">Midfielder</option>
                                <option value="Defender">Defender</option>
                            </select>
                        </div>
                        <div>
                            <label for="new-player-personality" class="block text-sm font-bold mb-1">Personality:</label>
                            <select id="new-player-personality" class="mb-2">
                                <option value="consistent">Consistent</option>
                                <option value="enthusiastic">Enthusiastic</option>
                                <option value="mischievous">Mischievous</option>
                                <option value="injuryProne">Injury Prone</option>
                                <option value="cricketLover">Cricket Lover</option>
                                <option value="quiet">Quiet</option>
                                <option value="leader">Leader</option>
                                <option value="speedy">Speedy</option>
                                <option value="creative">Creative</option>
                                <option value="reliable">Reliable</option>
                                <option value="agile">Agile</option>
                                <option value="newcomer">Newcomer</option>
                                <option value="moaner">Moaner</option>
                                <option value="unreliable">Unreliable</option>
                                <option value="lowConfidence">Low Confidence</option>
                                <option value="fittest">Fittest</option>
                                <option value="aggressive">Aggressive</option>
                            </select>
                        </div>
                        <div>
                            <label for="new-parent-name" class="block text-sm font-bold mb-1">Parent Name (Optional):</label>
                            <input type="text" id="new-parent-name" placeholder="Parent Name" class="mb-2">
                        </div>
                        <div class="md:col-span-2">
                            <label for="new-player-description" class="block text-sm font-bold mb-1">Player Description (Optional):</label>
                            <input type="text" id="new-player-description" placeholder="Short description of player" class="mb-2">
                        </div>
                    </div>
                    <button onclick="addNewPlayer()" class="btn mt-4 w-full">Add Player</button>
                </div>

                <div class="flex justify-center mt-8">
                    <button onclick="showLeagueTable()" class="btn mr-4"><i class="fas fa-table mr-2"></i>View League Table</button>
                    <button onclick="displayCombinedSelectionScreen()" class="btn"><i class="fas fa-users mr-2"></i>Select Squad for Match</button>
                </div>
            `;
            renderScreen(trainingHtml);
        }

        function addNewPlayer() {
            const playerName = document.getElementById('new-player-name').value.trim();
            const playerPos = document.getElementById('new-player-pos').value;
            const playerPersonality = document.getElementById('new-player-personality').value;
            const parentName = document.getElementById('new-parent-name').value.trim();
            const playerDescription = document.getElementById('new-player-description').value.trim();


            if (!playerName) {
                showMessageBox("Please enter a player name.");
                return;
            }

            const playerId = generateUniqueId();
            let parentId = null;

            if (parentName) {
                parentId = generateUniqueId();
                parents.push({
                    id: parentId,
                    name: parentName,
                    childName: playerName,
                    reactionBias: 0, // Default for new parents
                    happiness: 75,
                    description: `${parentName} (Parent of ${playerName})` // Default description
                });
            }

            players.push({
                id: playerId,
                name: playerName,
                personality: playerPersonality,
                position: playerPos,
                fitness: 70, // Default starting stats
                morale: 70,
                readiness: 70,
                isInjured: false,
                injuryDuration: 0,
                matchRating: 0,
                attendanceBias: 0, // Default
                parentId: parentId,
                description: playerDescription
            });

            document.getElementById('new-player-name').value = '';
            document.getElementById('new-parent-name').value = '';
            document.getElementById('new-player-description').value = '';
            showMessageBox(`${playerName} has joined the team!`);
            startWeek(); // Re-render the training screen with the new player
        }


        function conductTraining(type) {
            updatePlayerStats(type);
            showMessageBox(`Training session (${type}) completed! Players stats updated.`, displayCombinedSelectionScreen);
        }

        // --- Combined Squad and Lineup Selection Screen ---
        function displayCombinedSelectionScreen() {
            const availablePlayersForSelection = players.filter(p => !p.isInjured && p.isAttending);

            if (availablePlayersForSelection.length === 0) {
                showMessageBox("No players available for the match this week! Season will continue next week if any fixtures are left.", () => {
                    if (currentWeek < totalWeeks) {
                        startWeek();
                    } else {
                        endSeason();
                    }
                });
                return;
            }

            selectedLineup = []; // Reset lineup
            selectedSquad = []; // Reset full squad (starters + subs)
            designatedGoalkeeperId = null;

            let combinedSelectionHtml = `
                <h2 class="text-3xl font-bold mb-4">Week ${currentWeek}: Squad & Lineup Selection</h2>
                <p class="text-lg mb-4">Select your starting 11 players and up to 4 substitutes (max 15 total squad members).</p>
                <p class="text-sm text-yellow-300 mb-6">Fitness (F), Morale (M), Readiness (R)</p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 text-left player-role-selection">
                    <div class="card p-4">
                        <h3 class="text-xl font-bold mb-2">Available Players:</h3>
                        <div class="scrollable-list" id="all-available-players-list">
                            ${availablePlayersForSelection.map(p => `
                                <div class="flex items-center justify-between p-1 rounded-md hover:bg-gray-700 cursor-pointer player-item" data-player-id="${p.id}">
                                    <span>
                                        ${p.name} (${p.position}) <br>
                                        <span class="text-xs text-gray-400">R:${p.readiness}</span>
                                    </span>
                                    <div>
                                        <label class="inline-flex items-center cursor-pointer">
                                            <input type="radio" name="player-role-${p.id}" value="starter" class="form-radio h-4 w-4 text-green-500 starter-radio" data-player-id="${p.id}" ${selectedLineup.includes(p) ? 'checked' : ''}>
                                            <span class="ml-1 text-sm">Start</span>
                                        </label>
                                        <label class="inline-flex items-center cursor-pointer ml-3">
                                            <input type="radio" name="player-role-${p.id}" value="sub" class="form-radio h-4 w-4 text-blue-500 sub-radio" data-player-id="${p.id}" ${selectedSquad.includes(p) && !selectedLineup.includes(p) ? 'checked' : ''}>
                                            <span class="ml-1 text-sm">Sub</span>
                                        </label>
                                        <label class="inline-flex items-center cursor-pointer ml-3">
                                            <input type="radio" name="player-role-${p.id}" value="none" class="form-radio h-4 w-4 text-gray-500 none-radio" data-player-id="${p.id}" ${!selectedSquad.includes(p) ? 'checked' : ''}>
                                            <span class="ml-1 text-sm">None</span>
                                        </label>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="card p-4">
                        <h3 class="text-xl font-bold mb-2">Starting XI (<span id="lineup-count">0</span>/11):</h3>
                        <ul id="selected-lineup-display" class="list-disc list-inside scrollable-list mb-4 max-h-[200px]">
                            <!-- Selected starters will appear here -->
                        </ul>

                        <h3 class="text-xl font-bold mb-2 mt-4">Substitutes (<span id="subs-count">0</span>/4):</h3>
                        <ul id="selected-subs-display" class="list-disc list-inside scrollable-list mb-4 max-h-[100px]">
                            <!-- Selected subs will appear here -->
                        </ul>

                        <h3 class="text-xl font-bold mb-2 mt-4">Designate Goalkeeper:</h3>
                        <select id="goalkeeper-select" class="w-full">
                            <option value="">-- Select Goalkeeper --</option>
                            <!-- Goalkeeper options will be populated by JS -->
                        </select>
                    </div>
                </div>

                <div class="flex justify-center mt-6">
                    <button id="confirm-squad-lineup-btn" class="btn text-xl px-8 py-3 w-full max-w-sm flex items-center justify-center" disabled>
                        Confirm Selection & Play Match <i class="fas fa-futbol ml-2"></i>
                    </button>
                </div>
            `;
            renderScreen(combinedSelectionHtml);

            document.getElementById('all-available-players-list').addEventListener('change', (event) => {
                if (event.target.type === 'radio' && event.target.name.startsWith('player-role-')) {
                    const playerId = event.target.dataset.playerId;
                    const player = players.find(p => p.id === playerId);
                    const role = event.target.value;

                    // Remove player from current roles first
                    selectedLineup = selectedLineup.filter(p => p.id !== playerId);
                    selectedSquad = selectedSquad.filter(p => p.id !== playerId); // Always remove from full squad before re-adding

                    if (role === 'starter') {
                        if (selectedLineup.length < 11) {
                            selectedLineup.push(player);
                            selectedSquad.push(player); // Add to full squad as well
                        } else {
                            showMessageBox("You can only select up to 11 players for the starting lineup.");
                            // Revert radio button state
                            event.target.checked = false;
                            const prevRole = player.prevRole || 'none'; // Get previous role or default to 'none'
                            document.querySelector(`input[name="player-role-${playerId}"][value="${prevRole}"]`).checked = true;
                            // Re-add to previous role if it was starter/sub to maintain counts
                            if (prevRole === 'starter') selectedLineup.push(player);
                            if (prevRole !== 'none') selectedSquad.push(player);
                        }
                    } else if (role === 'sub') {
                        const currentSubsCount = selectedSquad.filter(p => !selectedLineup.includes(p)).length;
                        if (currentSubsCount < 4) {
                            selectedSquad.push(player); // Add to full squad
                        } else {
                            showMessageBox("You can only select up to 4 substitutes.");
                            // Revert radio button state
                            event.target.checked = false;
                            const prevRole = player.prevRole || 'none';
                            document.querySelector(`input[name="player-role-${playerId}"][value="${prevRole}"]`).checked = true;
                            if (prevRole === 'starter') selectedLineup.push(player);
                            if (prevRole !== 'none') selectedSquad.push(player);
                        }
                    }
                    // Store the current role as previous role for potential re-checking
                    if (player) player.prevRole = role;

                    updateCombinedSelectionCounts();
                    renderCombinedSelectionLists();
                    populateGoalkeeperSelect();
                }
            });

            document.getElementById('goalkeeper-select').addEventListener('change', (event) => {
                designatedGoalkeeperId = event.target.value;
                updateCombinedSelectionCounts(); // This will enable/disable the button
                renderCombinedSelectionLists(); // Update GK indicator in lineup
            });

            // Initial render
            updateCombinedSelectionCounts();
            renderCombinedSelectionLists();
            populateGoalkeeperSelect();
        }

        function updateCombinedSelectionCounts() {
            const lineupCountElement = document.getElementById('lineup-count');
            const subsCountElement = document.getElementById('subs-count');
            const confirmBtn = document.getElementById('confirm-squad-lineup-btn');

            if (lineupCountElement) lineupCountElement.textContent = selectedLineup.length;
            if (subsCountElement) subsCountElement.textContent = selectedSquad.length - selectedLineup.length;

            if (confirmBtn) {
                // Button is enabled if:
                // 1. Exactly 11 players are selected for the starting lineup.
                // 2. A goalkeeper is designated.
                // 3. Total selected squad is between 11 and 15 (11 starters + 0-4 subs).
                const totalSquadSize = selectedSquad.length;
                const isValidLineupCount = selectedLineup.length === 11;
                const isValidSubCount = (selectedSquad.length - selectedLineup.length) <= 4;
                const isGoalkeeperDesignated = designatedGoalkeeperId !== null && designatedGoalkeeperId !== "";

                confirmBtn.disabled = !(isValidLineupCount && isValidSubCount && isGoalkeeperDesignated);
                confirmBtn.onclick = startMatchSimulation;
            }
        }

        function renderCombinedSelectionLists() {
            const selectedLineupDisplay = document.getElementById('selected-lineup-display');
            const selectedSubsDisplay = document.getElementById('selected-subs-display');

            if (selectedLineupDisplay) {
                selectedLineupDisplay.innerHTML = selectedLineup.map(p => `
                    <li>${p.name} (${p.position}) - R:${p.readiness} ${p.id === designatedGoalkeeperId ? '<span class="text-blue-400 font-bold">(GK)</span>' : ''}</li>
                `).join('');
            }
            if (selectedSubsDisplay) {
                const subs = selectedSquad.filter(p => !selectedLineup.includes(p));
                selectedSubsDisplay.innerHTML = subs.map(p => `
                    <li>${p.name} (${p.position}) - R:${p.readiness}</li>
                `).join('');
            }
        }

        function populateGoalkeeperSelect() {
            const gkSelect = document.getElementById('goalkeeper-select');
            if (!gkSelect) return;

            const currentGK = gkSelect.value;
            gkSelect.innerHTML = '<option value="">-- Select Goalkeeper --</option>';

            selectedLineup.forEach(player => {
                const option = document.createElement('option');
                option.value = player.id;
                option.textContent = player.name;
                gkSelect.appendChild(option);
            });

            if (selectedLineup.some(p => p.id === currentGK)) {
                gkSelect.value = currentGK;
                designatedGoalkeeperId = currentGK;
            } else {
                designatedGoalkeeperId = null;
            }
            updateCombinedSelectionCounts();
        }

        // --- Live Match Simulation ---
        let currentHanhamScore = 0;
        let currentOpponentScore = 0;
        let commentaryLog = [];

        function startMatchSimulation() {
            const hanhamTeam = teams.find(t => t.name === "Hanham Abbotonians");
            const currentHanhamFixture = fixtures.find(f =>
                f.week === currentWeek && (f.home === hanhamTeam.name || f.away === hanhamTeam.name)
            );
            const opponentName = currentHanhamFixture.home === hanhamTeam.name ? currentHanhamFixture.away : currentHanhamFixture.home;
            const opponentTeam = teams.find(t => t.name === opponentName);

            currentHanhamScore = 0;
            currentOpponentScore = 0;
            matchMinutes = 0;
            isMatchPaused = false;
            hanhamGoals = []; // Reset goal scorers

            let matchScreenHtml = `
                <h2 class="text-3xl font-bold mb-4">Week ${currentWeek}: Match Day!</h2>
                <div class="card p-4 mb-6">
                    <p class="text-2xl font-bold mb-2">${hanhamTeam.name} vs ${opponentTeam.name}</p>
                    <p class="text-4xl font-extrabold text-yellow-400 mb-4">
                        <span id="hanham-score">${currentHanhamScore}</span> - <span id="opponent-score">${currentOpponentScore}</span>
                    </p>
                    <p class="text-xl">Minute: <span id="match-minute">0</span></p>
                </div>

                <div class="commentary-log mb-6" id="commentary-log">
                    <p>Match kicks off!</p>
                </div>

                <div class="flex justify-center mt-6">
                    <button onclick="showSubstitutionModal()" class="btn" id="make-sub-btn">
                        <i class="fas fa-exchange-alt mr-2"></i> Make Sub
                    </button>
                </div>
            `;
            renderScreen(matchScreenHtml);

            // Start the match loop
            matchInterval = setInterval(updateMatchProgress, 500); // Update every 0.5 seconds for faster simulation
        }

        function updateMatchProgress() {
            if (isMatchPaused) {
                return; // Do nothing if match is paused
            }

            matchMinutes += Math.floor(Math.random() * 5) + 1; // Advance 1-5 minutes per tick

            const hanhamTeam = teams.find(t => t.name === "Hanham Abbotonians");
            const currentHanhamFixture = fixtures.find(f =>
                f.week === currentWeek && (f.home === hanhamTeam.name || f.away === hanhamTeam.name)
            );
            const opponentName = currentHanhamFixture.home === hanhamTeam.name ? currentHanhamFixture.away : currentHanhamFixture.home;
            const opponentTeam = teams.find(t => t.name === opponentName);

            // Calculate Hanham's effective strength for event generation
            let hanhamReadinessSum = selectedLineup.reduce((sum, p) => sum + p.readiness, 0);
            let hanhamAvgReadiness = selectedLineup.length > 0 ? hanhamReadinessSum / selectedLineup.length : 50;
            let hanhamEffectiveStrength = hanhamTeam.strength * (hanhamAvgReadiness / 100);

            const opponentStrength = opponentTeam.strength;

            const logCommentary = (comment) => {
                const commentaryDiv = document.getElementById('commentary-log');
                if (commentaryDiv) {
                    const p = document.createElement('p');
                    p.innerHTML = `<strong>Min ${matchMinutes}:</strong> ${comment}`;
                    commentaryDiv.appendChild(p);
                    commentaryDiv.scrollTop = commentaryDiv.scrollHeight; // Auto-scroll
                }
            };

            // Random events based on relative strengths
            if (Math.random() < 0.15) { // Chance for a significant event every few minutes
                const eventType = Math.random();
                if (eventType < 0.45) { // 45% chance for Hanham to attack
                    if (Math.random() * hanhamEffectiveStrength > Math.random() * opponentStrength * 0.8) { // Hanham chance
                        logCommentary("Hanham Abbotonians pushing forward!");
                        if (Math.random() * hanhamEffectiveStrength > Math.random() * opponentStrength * 1.2) { // Hanham goal chance
                            const scorer = selectedLineup[Math.floor(Math.random() * selectedLineup.length)];
                            currentHanhamScore++;
                            hanhamGoals.push(scorer.name);
                            document.getElementById('hanham-score').textContent = currentHanhamScore;
                            logCommentary(`<span class="text-yellow-400 font-bold">GOAL! ${scorer.name} scores for Hanham Abbotonians!</span>`);
                            goalSound.play();
                        } else {
                            logCommentary("Great save by the opponent's keeper!");
                        }
                    } else {
                        logCommentary("Hanham attack breaks down.");
                    }
                } else if (eventType < 0.90) { // 45% chance for Opponent to attack
                    if (Math.random() * opponentStrength > Math.random() * hanhamEffectiveStrength * 0.8) { // Opponent chance
                        logCommentary(`${opponentName} on the attack!`);
                        if (Math.random() * opponentStrength > Math.random() * hanhamEffectiveStrength * 1.2) { // Opponent goal chance
                            currentOpponentScore++;
                            document.getElementById('opponent-score').textContent = currentOpponentScore;
                            logCommentary(`<span class="text-red-400 font-bold">Goal! ${opponentName} scores!</span>`);
                        } else {
                            logCommentary("Designated keeper made a crucial save!");
                        }
                    } else {
                        logCommentary(`${opponentName}'s attack fizzles out.`);
                    }
                } else { // 10% for other events
                    const otherEvent = Math.random();
                    if (otherEvent < 0.3) logCommentary("Midfield battle intensifying.");
                    else if (otherEvent < 0.6) logCommentary("Tactical foul in the center circle.");
                    else logCommentary("A few strong challenges going in.");
                }
            }

            document.getElementById('match-minute').textContent = matchMinutes;

            if (matchMinutes >= 90) {
                clearInterval(matchInterval);
                whistleSound.play();
                logCommentary("Full time! The whistle blows!");
                // Give a small delay before showing report to let last commentary appear
                setTimeout(() => {
                    endLiveMatch(currentHanhamScore, currentOpponentScore);
                }, 2000);
            }
        }

        function endLiveMatch(finalHanhamScore, finalOpponentScore) {
            const hanhamTeam = teams.find(t => t.name === "Hanham Abbotonians");
            const currentHanhamFixture = fixtures.find(f =>
                f.week === currentWeek && (f.home === hanhamTeam.name || f.away === hanhamTeam.name)
            );
            const opponentName = currentHanhamFixture.home === hanhamTeam.name ? currentHanhamFixture.away : currentHanhamFixture.home;
            const opponentTeam = teams.find(t => t.name === opponentName);

            let hanhamResult = '';
            let natchEarned = 0;
            if (finalHanhamScore > finalOpponentScore) {
                hanhamResult = 'Win';
                natchEarned = 10;
            } else if (finalHanhamScore < finalOpponentScore) {
                hanhamResult = 'Loss';
                natchEarned = 2;
            } else {
                hanhamResult = 'Draw';
                natchEarned = 5;
            }
            natchCider += natchEarned;

            // Simulate injuries during match (low chance)
            selectedLineup.forEach(player => {
                if (Math.random() < 0.05 && !player.isInjured) { // 5% chance
                    player.isInjured = true;
                    player.injuryDuration = Math.floor(Math.random() * 2) + 1; // 1-2 weeks out
                    showMessageBox(`${player.name} picked up a knock during the match! Out for ${player.injuryDuration} week(s).`);
                }
            });

            // Player Match Ratings (1-10)
            selectedLineup.forEach(player => {
                let baseRating = 5; // Start with a mid-range rating
                baseRating += (player.readiness - 70) / 10; // Readiness impact

                if (hanhamResult === 'Win') baseRating += 1;
                else if (hanhamResult === 'Loss') baseRating -= 1;
                else if (hanhamResult === 'Draw') baseRating += 0.5;

                // Goalkeeper specific adjustment
                if (player.id === designatedGoalkeeperId) {
                    baseRating += (finalOpponentScore === 0 ? 1.5 : (finalOpponentScore > 2 ? -1.5 : 0));
                }

                // Personality specific adjustments
                if (player.personality === 'fittest') baseRating += 0.5; // Always works hard
                if (player.personality === 'creative' && hanhamGoals.includes(player.name)) baseRating += 1; // Rewards for goals/assists
                if (player.personality === 'aggressive' && hanhamResult === 'Win') baseRating += 0.5;
                if (player.personality === 'moaner' && hanhamResult === 'Loss') baseRating -= 0.5; // Negative impact
                if (player.personality === 'lowConfidence' && hanhamResult === 'Loss') baseRating -= 0.5; // Negative impact
                if (player.personality === 'injuryProne' && player.isInjured) baseRating -= 1; // Injured during game = bad rating

                // Add some randomness
                baseRating += (Math.random() * 2 - 1); // +/- 1

                player.matchRating = Math.max(1, Math.min(10, Math.round(baseRating)));
            });

            // Dave's Commentary
            let manOfTheMatch = null;
            let plonkerOfTheWeek = null;
            let highestRating = -1;
            let lowestRating = 11;

            selectedLineup.forEach(player => {
                if (player.matchRating > highestRating) {
                    highestRating = player.matchRating;
                    manOfTheMatch = player;
                }
                if (player.matchRating < lowestRating) {
                    lowestRating = player.matchRating;
                    plonkerOfTheWeek = player;
                }
            });

            const getMotmJustification = (player) => {
                if (!player) return "No outstanding performer this week, everyone put in a decent shift.";
                let justification = "";
                if (player.personality === 'fittest') justification += `${player.name} ran tirelessly all game, dominating the midfield.`;
                else if (player.personality === 'creative') justification += `${player.name}'s intelligent play and creativity opened up the opponent, truly a joy to watch.`;
                else if (player.personality === 'leader') justification += `${player.name} led by example, rallying the team from start to finish.`;
                else if (player.personality === 'speedy' && hanhamGoals.includes(player.name)) justification += `${player.name}'s blistering pace was too much for the opposition, capping it off with a crucial goal.`;
                else justification += `${player.name} put in a superb performance, showing great skill and determination throughout the match.`;
                return justification;
            };

            const getPotwJustification = (player) => {
                if (!player) return "Everyone gave their all this week!";
                let justification = "";
                if (player.personality === 'moaner') justification += `Caspar seemed to have one of his off-days, letting his frustrations get the better of him.`;
                else if (player.personality === 'lowConfidence') justification += `Billy struggled to find his rhythm today, looking a bit short on confidence. He'll bounce back next week.`;
                else if (player.personality === 'injuryProne') justification += `${player.name} just couldn't shake off his injury concerns, it hampered his game.`;
                else if (player.personality === 'mischievous') justification += `Ashton looked more interested in what was happening off the pitch than on it, needs to focus.`;
                else justification += `${player.name} had a difficult day at the office, needs to dust himself off and go again.`;
                return justification;
            };


            // Parent Reactions
            parents.forEach(parent => {
                const child = players.find(p => p.parentId === parent.id);
                if (child) {
                    const childInLineup = selectedLineup.find(p => p.id === child.id);
                    if (!childInLineup) {
                        parent.happiness = Math.max(0, parent.happiness - (5 + parent.reactionBias)); // Child not playing
                        if (parent.happiness < 50) {
                            natchCider = Math.max(0, natchCider - 1); // Lose a Natch for very upset parents
                            // Personality reveal for parent
                            if (parent.name === 'Aimee') showMessageBox(`Aimee (Ashton's parent) looks disgruntled. As the club safeguarding officer, she probably wanted Ashton to get some game time.`);
                            else if (parent.name === 'Craig') showMessageBox(`Craig (Caspar's parent) seems annoyed that Caspar didn't play. Dave notes Craig is always distracted.`);
                            else if (parent.name === 'Neil') showMessageBox(`Neil (Ewan's parent) is packing up his chair, clearly not happy Ewan didn't feature. Typical Neil.`);
                        }
                    } else {
                        parent.happiness = Math.min(100, parent.happiness + (childInLineup.matchRating - 5) + parent.reactionBias);
                        if (childInLineup.matchRating >= 8) natchCider++; // Extra Natch for good performance
                        if (parent.name === "Craig" && Math.random() < 0.2) {
                            // Craig distracted, 20% chance of no Natch bonus even if child plays well
                        } else if (parent.name === "Alex" && childInLineup.matchRating < 5) {
                             natchCider = Math.max(0, natchCider - 1);
                             showMessageBox(`Dave notes Alex's shouting at Jakub from the sidelines has cost you a Natch!`);
                        } else if (parent.name === "Marcus" && childInLineup.matchRating >= 7) {
                            // Marcus is a club man, very supportive
                            if (Math.random() < 0.5) showMessageBox(`Marcus (Kyle R's parent) is beaming, clearly proud of Kyle R's performance. His positive attitude is great for the club.`);
                        }
                    }
                }
            });


            // Update Hanham Abbotonians in league table
            const hanhamLeagueStats = leagueTable.find(t => t.name === hanhamTeam.name);
            if (hanhamLeagueStats) {
                hanhamLeagueStats.played++;
                hanhamLeagueStats.goalsFor += finalHanhamScore;
                hanhamLeagueStats.goalsAgainst += finalOpponentScore;
                if (hanhamResult === 'Win') {
                    hanhamLeagueStats.wins++;
                    hanhamLeagueStats.points += 3;
                } else if (hanhamResult === 'Draw') {
                    hanhamLeagueStats.draws++;
                    hanhamLeagueStats.points += 1;
                } else {
                    hanhamLeagueStats.losses++;
                }
                hanhamLeagueStats.goalDifference = hanhamLeagueStats.goalsFor - hanhamLeagueStats.goalsAgainst;
            }

            // Update opponent team in league table
            const opponentLeagueStats = leagueTable.find(t => t.name === opponentTeam.name);
            if (opponentLeagueStats) {
                opponentLeagueStats.played++;
                opponentLeagueStats.goalsFor += finalOpponentScore;
                opponentLeagueStats.goalsAgainst += finalHanhamScore;
                if (hanhamResult === 'Loss') { // If Hanham lost, opponent won
                    opponentLeagueStats.wins++;
                    opponentLeagueStats.points += 3;
                } else if (hanhamResult === 'Draw') { // If Hanham drew, opponent drew
                    opponentLeagueStats.draws++;
                    opponentLeagueStats.points += 1;
                } else { // If Hanham won, opponent lost
                    opponentLeagueStats.losses++;
                }
                opponentLeagueStats.goalDifference = opponentLeagueStats.goalsFor - opponentLeagueStats.goalsAgainst;
            }

            // Update the current Hanham fixture with its result
            currentHanhamFixture.homeScore = currentHanhamFixture.home === hanhamTeam.name ? finalHanhamScore : finalOpponentScore;
            currentHanhamFixture.awayScore = currentHanhamFixture.away === hanhamTeam.name ? finalHanhamScore : finalOpponentScore;
            currentHanhamFixture.result = hanhamResult;


            // Simulate all other league matches for the week that haven't been played
            simulateOtherLeagueResults(currentWeek, hanhamTeam.name); // Pass Hanham name to exclude

            displayMatchReport(hanhamTeam, opponentTeam, finalHanhamScore, finalOpponentScore, hanhamResult, manOfTheMatch, plonkerOfTheWeek, getMotmJustification(manOfTheMatch), getPotwJustification(plonkerOfTheWeek));
        }

        function showSubstitutionModal() {
            isMatchPaused = true;
            const subModal = document.getElementById('substitution-modal');
            subModal.style.display = 'block';

            const playerOffSelect = document.getElementById('player-off-select');
            const playerOnSelect = document.getElementById('player-on-select');

            playerOffSelect.innerHTML = '<option value="">-- Select Player Off --</option>';
            playerOnSelect.innerHTML = '<option value="">-- Select Player On --</option>';

            // Populate players to come off (from starting lineup)
            selectedLineup.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.name;
                playerOffSelect.appendChild(option);
            });

            // Populate players to come on (from selectedSquad, but not in current lineup, and not injured)
            const availableSubs = selectedSquad.filter(p => !selectedLineup.includes(p) && !p.isInjured);
            availableSubs.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.name} (R:${p.readiness})`;
                playerOnSelect.appendChild(option);
            });
        }

        function performSubstitution() {
            const playerOffId = document.getElementById('player-off-select').value;
            const playerOnId = document.getElementById('player-on-select').value;

            if (!playerOffId || !playerOnId) {
                showMessageBox("Please select both a player to come off and a player to come on.");
                return;
            }

            const playerOff = players.find(p => p.id === playerOffId);
            const playerOn = players.find(p => p.id === playerOnId);

            if (!playerOff || !playerOn) {
                showMessageBox("Error: Player not found.");
                return;
            }

            if (playerOn.isInjured) {
                showMessageBox(`${playerOn.name} is currently injured and cannot come on.`);
                return;
            }

            // Perform the substitution
            const indexOff = selectedLineup.indexOf(playerOff);
            if (indexOff > -1) {
                selectedLineup.splice(indexOff, 1, playerOn); // Replace playerOff with playerOn

                // If the player coming off was the GK
                if (designatedGoalkeeperId === playerOff.id) {
                    // Check if the new player is also a good GK (e.g., if GK is a dedicated position)
                    // For now, if GK is subbed off, simply clear GK designation. User needs to pick again from the lineup.
                    designatedGoalkeeperId = null;
                    showMessageBox(`Dave notes ${playerOff.name} is off. Please designate a new goalkeeper from the current lineup, then press OK to resume.`);
                    // To force GK selection, we can re-render selection screen or keep modal open.
                    // For now, we'll let the user pick in the next step by keeping modal open and calling `populateGoalkeeperSelect`.
                    populateGoalkeeperSelect();
                    // Do not resume match automatically; wait for GK selection
                    return;
                }

                const commentaryDiv = document.getElementById('commentary-log');
                if (commentaryDiv) {
                    const p = document.createElement('p');
                    p.innerHTML = `<strong>Min ${matchMinutes}:</strong> Substitution! ${playerOff.name} off, ${playerOn.name} on.`;
                    commentaryDiv.appendChild(p);
                    commentaryDiv.scrollTop = commentaryDiv.scrollHeight;
                }

                document.getElementById('substitution-modal').style.display = 'none';
                isMatchPaused = false; // Resume match
            } else {
                showMessageBox("Error: Player selected to come off is not in the starting lineup.");
            }
        }

        function cancelSubstitution() {
            document.getElementById('substitution-modal').style.display = 'none';
            isMatchPaused = false; // Resume match without sub
        }


        function simulateOtherLeagueResults(week, hanhamName) {
            // Get all fixtures for the current week (that includes non-Hanham matches)
            const fixturesThisWeek = fixtures.filter(f => f.week === week);

            fixturesThisWeek.forEach(f => {
                // Only simulate if it's not Hanham's match and it hasn't been played yet
                if (f.home !== hanhamName && f.away !== hanhamName && f.result === null) {
                    const teamA = teams.find(t => t.name === f.home);
                    const teamB = teams.find(t => t.name === f.away);

                    if (teamA && teamB) {
                        const scoreA = Math.floor(Math.random() * (teamA.strength / 10)) + Math.floor(Math.random() * 2);
                        const scoreB = Math.floor(Math.random() * (teamB.strength / 10)) + Math.floor(Math.random() * 2);

                        updateTeamLeagueStats(teamA.name, scoreA, scoreB);
                        updateTeamLeagueStats(teamB.name, scoreB, scoreA);

                        f.homeScore = scoreA;
                        f.awayScore = scoreB;
                        if (scoreA > scoreB) f.result = 'H';
                        else if (scoreA < scoreB) f.result = 'A';
                        else f.result = 'D';
                    }
                }
            });
            sortLeagueTable(); // Always sort after updates
        }

        function updateTeamLeagueStats(teamName, goalsFor, goalsAgainst) {
            const teamStats = leagueTable.find(t => t.name === teamName);
            if (teamStats) {
                teamStats.played++;
                teamStats.goalsFor += goalsFor;
                teamStats.goalsAgainst += goalsAgainst;
                if (goalsFor > goalsAgainst) {
                    teamStats.wins++;
                    teamStats.points += 3;
                } else if (goalsFor === goalsAgainst) {
                    teamStats.draws++;
                    teamStats.points += 1;
                } else {
                    teamStats.losses++;
                }
                teamStats.goalDifference = teamStats.goalsFor - teamStats.goalsAgainst;
            }
        }

        function sortLeagueTable() {
            leagueTable.sort((a, b) => {
                if (b.points !== a.points) return b.points - a.points;
                if (b.goalDifference !== a.goalDifference) return b.goalDifference - a.goalDifference;
                return b.goalsFor - a.goalsFor;
            });
        }

        function displayMatchReport(hanhamTeam, opponentTeam, hanhamScore, opponentScore, hanhamResult, motm, potw, motmJustification, potwJustification) {
            let matchReportHtml = `
                <h2 class="text-3xl font-bold mb-4">Week ${currentWeek}: Match Report</h2>
                <div class="card p-4 mb-6">
                    <p class="text-2xl font-bold mb-2">${hanhamTeam.name} vs ${opponentTeam.name}</p>
                    <p class="text-4xl font-extrabold text-yellow-400 mb-4">${hanhamScore} - ${opponentScore}</p>
                    <p class="text-xl">Result: <span class="font-bold">${hanhamResult}</span></p>
                    <p class="text-lg mt-2">Hanham Scorers: ${hanhamGoals.length > 0 ? hanhamGoals.join(', ') : 'None'}</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="card p-4">
                        <h3 class="text-xl font-bold mb-2">Dave Booze's Commentary:</h3>
                        <p class="mb-2">Man of the Match: <span class="font-bold text-yellow-400">${motm ? motm.name : 'No one stood out!'}</span> (Rating: ${motm ? motm.matchRating : 'N/A'})</p>
                        <p class="text-sm italic mb-2">${motmJustification}</p>
                        <p>Plonker of the Week: <span class="font-bold text-red-400">${potw ? potw.name : 'Everyone was brilliant!'}</span> (Rating: ${potw ? potw.matchRating : 'N/A'})</p>
                        <p class="text-sm italic mb-2">${potwJustification}</p>
                        <p class="mt-4 text-xl">Dave's Natch Cider: <span class="font-bold">${natchCider} <i class="fas fa-beer text-yellow-400"></i></span></p>
                    </div>
                    <div class="card p-4">
                        <h3 class="text-xl font-bold mb-2">Player Match Ratings:</h3>
                        <ul class="list-disc list-inside scrollable-list">
                            ${selectedLineup.map(p => `
                                <li>${p.name}: ${p.matchRating}/10</li>
                            `).join('')}
                        </ul>
                    </div>
                </div>

                <h3 class="text-2xl font-bold mb-4">Other League Results:</h3>
                <div class="card p-4 mb-6">
                    <ul class="list-disc list-inside scrollable-list">
                        ${fixtures.filter(f => f.week === currentWeek && f.result && f.home !== hanhamTeam.name && f.away !== hanhamTeam.name).map(f => `
                            <li>${f.home} ${f.homeScore} - ${f.awayScore} ${f.away}</li>
                        `).join('')}
                    </ul>
                    ${fixtures.filter(f => f.week === currentWeek && f.home !== hanhamTeam.name && f.away !== hanhamTeam.name).length === 0 ? '<p>No other matches simulated this week.</p>' : ''}
                </div>


                <div class="flex justify-center mt-6">
                    <button onclick="showLeagueTable()" class="btn mr-4"><i class="fas fa-table mr-2"></i>View Updated League Table</button>
                    <button onclick="moveToNextWeek()" class="btn">Continue Season <i class="fas fa-forward ml-2"></i></button>
                </div>
            `;
            renderScreen(matchReportHtml);
        }

        function moveToNextWeek() {
            if (currentWeek < totalWeeks) {
                startWeek();
            } else {
                endSeason();
            }
        }

        function showLeagueTable() {
            sortLeagueTable(); // Ensure it's sorted before displaying

            let tableHtml = `
                <h2 class="text-3xl font-bold mb-4">League Table - Week ${currentWeek}</h2>
                <div class="card p-4 mb-6 overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr>
                                <th class="px-2 py-1">Pos</th>
                                <th class="px-2 py-1">Team</th>
                                <th class="px-2 py-1">P</th>
                                <th class="px-2 py-1">W</th>
                                <th class="px-2 py-1">D</th>
                                <th class="px-2 py-1">L</th>
                                <th class="px-2 py-1">GF</th>
                                <th class="px-2 py-1">GA</th>
                                <th class="px-2 py-1">GD</th>
                                <th class="px-2 py-1">Pts</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${leagueTable.map((team, index) => `
                                <tr class="${team.name === 'Hanham Abbotonians' ? 'bg-yellow-800 bg-opacity-30' : ''}">
                                    <td class="px-2 py-1">${index + 1}</td>
                                    <td class="px-2 py-1">${team.name}</td>
                                    <td class="px-2 py-1">${team.played}</td>
                                    <td class="px-2 py-1">${team.wins}</td>
                                    <td class="px-2 py-1">${team.draws}</td>
                                    <td class="px-2 py-1">${team.losses}</td>
                                    <td class="px-2 py-1">${team.goalsFor}</td>
                                    <td class="px-2 py-1">${team.goalsAgainst}</td>
                                    <td class="px-2 py-1">${team.goalDifference}</td>
                                    <td class="px-2 py-1 font-bold">${team.points}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-center mt-6">
                    <button onclick="continueFromLeagueTable()" class="btn">Back to Game <i class="fas fa-arrow-left ml-2"></i></button>
                </div>
            `;
            renderScreen(tableHtml);
        }

        function continueFromLeagueTable() {
            if (seasonComplete) {
                endSeason();
            } else if (currentWeek === 0) { // If viewed from welcome screen before first week
                displayWelcomeScreen();
            } else {
                // If the user navigates to the league table from the training screen,
                // they should return to the training screen.
                startWeek();
            }
        }


        function endSeason() {
            seasonComplete = true;
            // Log score to Google Analytics
            gtag('event', 'season_end', {
                'user_name': userName,
                'final_natch_cider': natchCider,
                'league_position': leagueTable.findIndex(t => t.name === "Hanham Abbotonians") + 1
            });
            saveScoreToLeaderboard(natchCider);

            let hanhamFinalPosition = leagueTable.findIndex(t => t.name === "Hanham Abbotonians") + 1;
            let hanhamStats = leagueTable.find(t => t.name === "Hanham Abbotonians");

            let endSeasonHtml = `
                <h2 class="text-4xl font-extrabold mb-6">Season Over!</h2>
                <div class="card p-6 mb-6">
                    <p class="text-2xl mb-2">Dave Booze's Final Standing:</p>
                    <p class="text-5xl font-extrabold text-yellow-400 mb-4">${hanhamFinalPosition}${getOrdinalSuffix(hanhamFinalPosition)} Place!</p>
                    <p class="text-xl">Total Natch Cider Collected: <span class="font-bold">${natchCider} <i class="fas fa-beer text-yellow-400"></i></span></p>
                    <p class="text-lg mt-4">Record: ${hanhamStats.wins} Wins, ${hanhamStats.draws} Draws, ${hanhamStats.losses} Losses</p>
                    <p class="text-lg">Goal Difference: ${hanhamStats.goalDifference}</p>
                </div>

                <div id="leaderboard-display-final" class="mt-8 card text-left">
                    <!-- Leaderboard will be displayed here -->
                </div>

                <button onclick="restartGame()" class="btn mt-8 text-xl px-8 py-3 w-full max-w-sm flex items-center justify-center">
                    Play Again! <i class="fas fa-redo ml-2"></i>
                </button>
            `;
            renderScreen(endSeasonHtml);
            // Leaderboard will update dynamically via the listener
        }

        function getOrdinalSuffix(i) {
            const j = i % 10, k = i % 100;
            if (j === 1 && k !== 11) return "st";
            if (j === 2 && k !== 12) return "nd";
            if (j === 3 && k !== 13) return "rd";
            return "th";
        }

        function restartGame() {
            currentWeek = 0;
            natchCider = 0;
            seasonComplete = false;
            selectedSquad = [];
            selectedLineup = [];
            designatedGoalkeeperId = null;
            hanhamGoals = [];

            // Reset player stats (maybe keep some morale/fitness carryover in real game)
            players.forEach(p => {
                p.fitness = 80;
                p.morale = 75;
                p.readiness = calculateReadiness(p);
                p.isInjured = false;
                p.injuryDuration = 0;
                p.matchRating = 0;
                p.isAttending = true; // Reset attendance for new season
                // Reset prevRole for selection screen
                p.prevRole = 'none';
            });

            // Reset parent happiness (optional, could carry over too)
            parents.forEach(p => p.happiness = 75);

            // Reset league table
            leagueTable = teams.map(team => ({
                ...team,
                played: 0,
                wins: 0,
                draws: 0,
                losses: 0,
                goalsFor: 0,
                goalsAgainst: 0,
                goalDifference: 0,
                points: 0
            }));
            generateFixtures(); // Re-generate fixtures for new season
            displayWelcomeScreen(); // Go back to welcome screen to enter username
        }

        // Expose functions to global scope for HTML inline calls
        window.conductTraining = conductTraining;
        window.displayCombinedSelectionScreen = displayCombinedSelectionScreen; // New combined selection screen
        window.startMatchSimulation = startMatchSimulation; // New live match simulation
        window.showLeagueTable = showLeagueTable;
        window.moveToNextWeek = moveToNextWeek;
        window.continueFromLeagueTable = continueFromLeagueTable;
        window.restartGame = restartGame;
        window.hideMessageBox = hideMessageBox;
        window.addNewPlayer = addNewPlayer;
        window.showSubstitutionModal = showSubstitutionModal;
        window.performSubstitution = performSubstitution;
        window.cancelSubstitution = cancelSubstitution;


        // Start the game by initializing Firebase and displaying welcome screen
        window.onload = firebaseInit;

    </script>
</body>
</html>
